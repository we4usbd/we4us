<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>প্রোফাইল - আমাদের জন্য আমরা</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDK এবং কনফিগারেশন (Common Setup) -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
      import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
      import { getFirestore, doc, getDoc, updateDoc, collection, query, where, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyDu8VDVXEbrLbqPmD24OPgNhbH5xjwi_vA",
        authDomain: "we4usnur.firebaseapp.com",
        projectId: "we4usnur",
        storageBucket: "we4usnur.firebasestorage.app",
        messagingSenderId: "1069907132834",
        appId: "1:1069907132834:web:f6aec92fc61c413767f2fb",
        measurementId: "G-LZCCHNFRSN"
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      window.auth = auth;
      window.db = db;
      window.doc = doc;
      window.getDoc = getDoc;
      window.updateDoc = updateDoc;
      window.collection = collection;
      window.query = query;
      window.where = where;
      window.getDocs = getDocs;
      window.deleteDoc = deleteDoc;
      window.onAuthStateChanged = onAuthStateChanged;
      window.signOut = signOut;
    </script>

    <style>
        /* CSS অপরিবর্তিত রাখা হয়েছে */
        :root {
            --primary: #e53935;
            --primary-dark: #c62828;
            --secondary: #f5f5f5;
            --text: #333;
            --text-light: #666;
            --white: #fff;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: var(--secondary); color: var(--text); line-height: 1.6; }
        .container { width: 100%; max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        .btn { padding: 10px 20px; border-radius: 30px; font-weight: 600; cursor: pointer; transition: var(--transition); border: none; font-size: 0.9rem; text-decoration: none; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background: var(--primary); color: var(--white); }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }
        .btn-outline:hover { background: var(--primary); color: var(--white); }
        .section-title { text-align: center; font-size: 2.5rem; margin-bottom: 40px; color: var(--text); }
        .notification { position: fixed; top: 0; left: 50%; transform: translate(-50%, -150%); background-color: #2c3e50; color: var(--white); padding: 15px 25px; border-radius: 0 0 10px 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 2000; font-weight: 500; transition: transform 0.4s ease-in-out; }
        .notification.show { transform: translate(-50%, 20px); }
        .notification.success { background-color: #4CAF50; }
        .notification.private { background-color: var(--primary); }
        header { background-color: var(--white); box-shadow: var(--shadow); position: sticky; top: 0; z-index: 1000; }
        .header-content { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; }
        .logo { display: flex; align-items: center; gap: 10px; color: var(--primary); font-weight: 700; font-size: 1.5rem; text-decoration: none; }
        .logo i { font-size: 1.8rem; }
        nav ul { display: flex; list-style: none; gap: 25px; }
        nav a { text-decoration: none; color: var(--text); font-weight: 500; transition: var(--transition); position: relative; }
        nav a:hover { color: var(--primary); }
        nav a::after { content: ''; position: absolute; bottom: -5px; left: 0; width: 0; height: 2px; background-color: var(--primary); transition: var(--transition); }
        nav a:hover::after { width: 100%; }
        .auth-buttons { display: flex; gap: 15px; }
        .mobile-menu { display: none; font-size: 1.5rem; cursor: pointer; }
        .page-section { transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out; opacity: 0; }
        #profileViewSection, #my-posts-section { transform: scale(0.98); }
        .page-section.visible { opacity: 1; transform: scale(1) translateY(0); }
        .header-button-group { opacity: 0; transition: opacity 0.3s ease-in-out; }
        .header-button-group.visible { opacity: 1; }
        .profile-view-section { padding: 60px 0; }
        .profile-view-container { background-color: var(--white); border-radius: 15px; box-shadow: var(--shadow); padding: 40px; max-width: 800px; margin: 0 auto; position: relative; overflow: hidden; }
        .profile-view-container::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 5px; background: linear-gradient(90deg, var(--primary), var(--primary-dark)); }
        .profile-header { text-align: center; margin-bottom: 30px; border-bottom: 1px solid #eee; padding-bottom: 30px; }
        .profile-name { font-size: 2rem; color: var(--text); font-weight: 600; margin-bottom: 5px; }
        .profile-location { font-size: 1rem; color: var(--text-light); }
        .profile-body { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
        .info-group { background-color: #f9f9f9; padding: 15px; border-radius: 10px; border-left: 4px solid var(--primary); }
        .info-label { display: block; font-weight: 500; color: var(--text-light); font-size: 0.9rem; margin-bottom: 5px; display: flex; align-items: center; gap: 8px; }
        .info-label i { color: var(--primary); }
        .info-value { font-weight: 600; color: var(--text); font-size: 1.1rem; }
        .info-value-container { display: flex; align-items: center; justify-content: space-between; }
        .copy-btn { background: transparent; border: none; color: var(--primary); cursor: pointer; font-size: 1.1rem; padding: 5px; border-radius: 5px; transition: all 0.2s ease; }
        .copy-btn:hover { background-color: #e0e0e0; }
        .copy-btn .fa-check { color: #4CAF50; }
        .blood-group-badge { display: inline-block; background-color: var(--primary); color: var(--white); padding: 5px 15px; border-radius: 20px; font-size: 1.2rem; font-weight: 700; }
        .willing-status.yes { color: #4CAF50; font-weight: 700; }
        .willing-status.no { color: #f44336; font-weight: 700; }
        .my-posts-section { padding: 0 0 60px 0; }
        .my-posts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 30px; max-width: 800px; margin: 0 auto; }
        .my-post-card { background-color: var(--white); border-radius: 15px; box-shadow: var(--shadow); border-top: 5px solid var(--primary); display: flex; flex-direction: column; }
        .my-post-card-body { padding: 20px; flex-grow: 1; }
        .my-post-card-info { display: flex; align-items: flex-start; gap: 12px; margin-bottom: 15px; font-size: 1rem; color: var(--text-light); }
        .my-post-card-info i { color: var(--primary); font-size: 1.1rem; width: 20px; margin-top: 3px; }
        .my-post-card-info .info-label { font-weight: 500; color: var(--text); }
        .my-post-card-footer { padding: 0 20px 20px; }
        .btn-cancel { background: #ffcdd2; color: var(--primary-dark); width: 100%; }
        .btn-cancel:hover { background: var(--primary); color: var(--white); }
        footer { background: #2c3e50; color: var(--white); padding: 60px 0 20px; }
        .footer-content { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 40px; margin-bottom: 40px; }
        .footer-column h3 { font-size: 1.3rem; margin-bottom: 20px; position: relative; padding-bottom: 10px; }
        .footer-column h3::after { content: ''; position: absolute; bottom: 0; left: 0; width: 50px; height: 2px; background: var(--primary); }
        .footer-links { list-style: none; padding: 0; }
        .footer-links li { margin-bottom: 10px; }
        .footer-links a { color: #ddd; text-decoration: none; transition: var(--transition); }
        .footer-links a:hover { color: var(--primary); padding-left: 5px; }
        .social-links { display: flex; gap: 15px; margin-top: 20px; }
        .social-links a { display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; background: rgba(255, 255, 255, 0.1); border-radius: 50%; color: var(--white); transition: var(--transition); }
        .social-links a:hover { background: var(--primary); transform: translateY(-3px); }
        .copyright { text-align: center; padding-top: 20px; border-top: 1px solid rgba(255, 255, 255, 0.1); font-size: 0.9rem; color: #aaa; }
        .nav-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: transparent; z-index: 1100; }
        .mobile-nav-window { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(150%); display: flex; align-items: center; gap: 5px; background: rgba(110, 100, 100, 0.3); backdrop-filter: blur(14px); -webkit-backdrop-filter: blur(14px); border: 1px solid rgba(255, 255, 255, 0.18); padding: 10px; border-radius: 50px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); z-index: 1200; transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .mobile-nav-window.open { transform: translateX(-50%) translateY(0); }
        .mobile-nav-window ul { list-style: none; display: flex; flex-direction: row; gap: 8px; margin: 0; padding: 0; }
        .mobile-nav-window a { display: block; background: var(--white); color: var(--text); padding: 8px 16px; border-radius: 30px; text-decoration: none; font-size: 0.9rem; font-weight: 500; white-space: nowrap; transition: var(--transition); }
        .mobile-nav-window a:hover { background-color: #f0f0f0; transform: translateY(-1px); }
        .close-mobile-nav { cursor: pointer; color: #f0f0f0; font-size: 1.8rem; font-weight: 400; line-height: 1; padding: 0 8px; font-family: Arial, sans-serif; transition: color 0.3s ease; }
        .close-mobile-nav:hover { color: var(--white); }
        @media (max-width: 768px) { nav { display: none; } .mobile-menu { display: block; } .profile-body { grid-template-columns: 1fr; } .my-posts-grid { grid-template-columns: 1fr; } }
        @media (max-width: 576px) { .header-content { flex-wrap: wrap; } .auth-buttons { margin-top: 15px; width: 100%; justify-content: center; } }
    </style>
</head>
<body>
    <div id="notification" class="notification"></div>
    <header>
        <div class="container">
            <div class="header-content">
                <a href="index.html" class="logo"><i class="fas fa-tint"></i><span>আমাদের জন্য আমরা</span></a>
                <nav><ul><li><a href="index.html">হোম</a></li><li><a href="#">রক্তদাতা</a></li><li><a href="#">জরুরি যোগাযোগ</a></li><li><a href="#">ইমারজেন্সি ব্লাড</a></li></ul></nav>
                <div id="view-mode-buttons" class="auth-buttons header-button-group"> 
                    <button id="publishBtn" class="btn btn-outline" style="display: none;"><i class="fas fa-upload"></i> লোড হচ্ছে...</button>
                    <button id="editProfileBtn" class="btn btn-outline"><i class="fas fa-edit"></i> এডিট</button>
                    <button id="emergencyBtn" class="btn btn-outline"><i class="fas fa-bullhorn"></i> ইমারজেন্সি ব্লাড</button>
                    <button id="logoutBtn" class="btn btn-outline"><i class="fas fa-sign-out-alt"></i> লগআউট</button>
                </div>
                <div class="mobile-menu"><i class="fas fa-bars"></i></div>
            </div>
        </div>
    </header>
    <div class="nav-overlay" id="navOverlay"></div>
    <div class="mobile-nav-window" id="mobileNavWindow"><ul><li><a href="index.html">হোম</a></li><li><a href="#">রক্তদাতা</a></li><li><a href="#">জরুরি যোগাযোগ</a></li><li><a href="#">ইমারজেন্সি ব্লাড</a></li></ul><div class="close-mobile-nav" id="closeMobileNav">&times;</div></div>

    <section id="profileViewSection" class="page-section profile-view-section">
        <div class="container">
            <div class="profile-view-container">
                <div class="profile-header">
                    <h1 class="profile-name" data-key="name">লোড হচ্ছে...</h1>
                    <p class="profile-location"><i class="fas fa-map-marker-alt"></i> <span data-key="location">...</span></p>
                </div>
                <div class="profile-body">
                    <div class="info-group"><span class="info-label"><i class="fas fa-tint"></i> রক্তের গ্রুপ</span><span class="info-value blood-group-badge" data-key="bloodGroup">...</span></div>
                    <div class="info-group"><span class="info-label"><i class="fas fa-check-circle"></i> রক্তদানে ইচ্ছুক</span><span class="info-value" data-key="willingness">...</span></div>
                    <div class="info-group"><span class="info-label"><i class="fas fa-phone"></i> মোবাইল নম্বর</span><div class="info-value-container"><span class="info-value" id="mobileNumber" data-key="mobile">...</span><button class="copy-btn" id="copyBtn" title="নম্বরটি কপি করুন"><i class="far fa-copy"></i></button></div></div>
                    <div class="info-group"><span class="info-label"><i class="fas fa-birthday-cake"></i> জন্ম তারিখ</span><span class="info-value" data-key="birthDate">...</span></div>
                    <div class="info-group"><span class="info-label"><i class="fas fa-calendar-alt"></i> বয়স</span><span class="info-value" data-key="age">...</span></div>
                    <div class="info-group"><span class="info-label"><i class="fas fa-weight"></i> ওজন</span><span class="info-value" data-key="weight">...</span></div>
                    <div class="info-group"><span class="info-label"><i class="fas fa-venus-mars"></i> জেন্ডার</span><span class="info-value" data-key="gender">...</span></div>
                    <div class="info-group"><span class="info-label"><i class="fas fa-heartbeat"></i> শেষ রক্তদানের তারিখ</span><span class="info-value" data-key="lastDonation">...</span></div>
                    <div class="info-group" style="grid-column: 1 / -1;"><span class="info-label"><i class="fas fa-map-marked-alt"></i> ঠিকানা</span><span class="info-value" data-key="fullAddress">...</span></div>
                </div>
            </div>
        </div>
    </section>

    <section id="my-posts-section" class="page-section my-posts-section">
        <div class="container">
            <h2 class="section-title" style="font-size: 2rem; margin-bottom: 30px;">আমার ইমারজেন্সি পোস্ট</h2>
            <div class="my-posts-grid" id="myEmergencyPostsGrid"></div>
        </div>
    </section>

    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-column"><h3>আমাদের জন্য আমরা</h3><p>জীবন বাঁচাতে রক্ত দিন। আমাদের প্ল্যাটফর্ম জরুরী অবস্থায় রক্তের প্রয়োজনীয়তা মেটাতে সাহায্য করে।</p><div class="social-links"><a href="#"><i class="fab fa-facebook-f"></i></a><a href="#"><i class="fab fa-twitter"></i></a><a href="#"><i class="fab fa-instagram"></i></a><a href="#"><i class="fab fa-linkedin-in"></i></a></div></div>
                <div class="footer-column"><h3>লিংকস</h3><ul class="footer-links"><li><a href="index.html">হোম</a></li><li><a href="#">রক্তদাতা</a></li><li><a href="#">জরুরি যোগাযোগ</a></li><li><a href="#">ইমারজেন্সি ব্লাড</a></li></ul></div>
                <div class="footer-column"><h3>সহায়তা</h3><ul class="footer-links"><li><a href="#">সাপোর্ট</a></li><li><a href="#">জরুরী যোগাযোগ</a></li><li><a href="#">রক্তদানের নিয়ম</a></li></ul></div>
                <div class="footer-column"><h3>যোগাযোগ</h3><ul class="footer-links"><li><i class="fas fa-map-marker-alt"></i> নাটোর, বাংলাদেশ</li><li><i class="fas fa-phone"></i> +880 1851956615</li><li><i class="fas fa-envelope"></i> info@nur.com</li></ul></div>
            </div>
            <div class="copyright"><p>&copy; ২০২৫ আমাদের জন্য আমরা. সকল অধিকার সংরক্ষিত।</p></div>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const profileViewSection = document.getElementById('profileViewSection');
            const myPostsSection = document.getElementById('my-posts-section');
            const viewModeButtons = document.getElementById('view-mode-buttons');
            const publishBtn = document.getElementById('publishBtn');
            const editProfileBtn = document.getElementById('editProfileBtn');
            const emergencyBtn = document.getElementById('emergencyBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            const notification = document.getElementById('notification');
            const mobileMenuIcon = document.querySelector('.mobile-menu');
            const mobileNavWindow = document.getElementById('mobileNavWindow');
            const closeMobileNavBtn = document.getElementById('closeMobileNav');
            const navOverlay = document.getElementById('navOverlay');

            const locationData = { "barishal": { "name": "বরিশাল" }, "chattogram": { "name": "চট্টগ্রাম" }, "dhaka": { "name": "ঢাকা" }, "khulna": { "name": "খুলনা" }, "mymensingh": { "name": "ময়মনসিংহ" }, "rajshahi": { "name": "রাজশাহী" }, "rangpur": { "name": "রংপুর" }, "sylhet": { "name": "সিলেট" } };

            function calculateAge(birthDateValue) {
                if (!birthDateValue) return '';
                const birthDate = new Date(birthDateValue);
                const today = new Date();
                let age = today.getFullYear() - birthDate.getFullYear();
                const monthDiff = today.getMonth() - birthDate.getMonth();
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) { age--; }
                return age >= 0 ? age : '';
            }

            let notificationTimeout;
            function showNotification(message, type) {
                clearTimeout(notificationTimeout);
                notification.textContent = message;
                notification.className = 'notification ' + type + ' show';
                notificationTimeout = setTimeout(() => { notification.classList.remove('show'); }, 3500);
            }

            // ফায়ারবেজ অথেনটিকেশন লিসেনার
            window.onAuthStateChanged(window.auth, async (user) => {
                if (user) {
                    initializePage();
                    
                    // ইউজারের ডাটা ফেচ করা
                    try {
                        const docRef = window.doc(window.db, "users", user.uid);
                        const docSnap = await window.getDoc(docRef);

                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            renderProfileView(data);
                            setupPublishButton(data.isPublished, user.uid);
                        } else {
                            // প্রোফাইল না থাকলে এডিট পেজে পাঠানো যেতে পারে
                            window.location.href = 'profile_edit.html';
                        }
                        
                        // ইমারজেন্সি পোস্ট লোড করা
                        loadMyEmergencyPosts(user.uid);

                    } catch (error) {
                        console.error("Error fetching data:", error);
                        showNotification("ডাটা লোড করতে সমস্যা হয়েছে", "private");
                    }
                } else {
                    window.location.href = 'log_in.html';
                }
            });

            function renderProfileView(data) {
                const age = calculateAge(data.birthDate);
                const divName = locationData[data.division]?.name || data.division;
                
                document.querySelector('[data-key="name"]').textContent = data.name || 'নাম নেই';
                document.querySelector('[data-key="location"]').textContent = `${data.upazila || ''}, ${data.district || ''}`;
                document.querySelector('[data-key="bloodGroup"]').textContent = data.bloodGroup || '-';
                
                const willingEl = document.querySelector('[data-key="willingness"]');
                willingEl.textContent = data.willingness === 'yes' ? 'হ্যাঁ' : 'না';
                willingEl.className = `info-value willing-status ${data.willingness}`;
                
                document.querySelector('[data-key="mobile"]').textContent = data.mobile || '-';
                document.querySelector('[data-key="birthDate"]').textContent = data.birthDate ? new Date(data.birthDate).toLocaleDateString('bn-BD') : '-';
                document.querySelector('[data-key="age"]').textContent = age ? `${age} বছর` : '-';
                document.querySelector('[data-key="weight"]').textContent = data.weight ? `${data.weight} কেজি` : '-';
                document.querySelector('[data-key="gender"]').textContent = data.gender === 'male' ? 'পুরুষ' : data.gender === 'female' ? 'মহিলা' : 'অন্যান্য';
                document.querySelector('[data-key="lastDonation"]').textContent = data.neverDonated ? 'কখনও রক্ত দেননি' : (data.lastDonation ? new Date(data.lastDonation).toLocaleDateString('bn-BD') : '-');
                document.querySelector('[data-key="fullAddress"]').textContent = `উপজেলা: ${data.upazila || ''}, জেলা: ${data.district || ''}, বিভাগ: ${divName || ''}`;
            }

            function setupPublishButton(isPublished, uid) {
                publishBtn.style.display = 'inline-flex';
                updatePublishButtonUI(isPublished);

                publishBtn.onclick = async () => {
                    const newStatus = !isPublished;
                    try {
                        await window.updateDoc(window.doc(window.db, "users", uid), {
                            isPublished: newStatus
                        });
                        isPublished = newStatus; // লোকাল ভেরিয়েবল আপডেট
                        updatePublishButtonUI(newStatus);
                        showNotification(newStatus ? 'আপনার প্রোফাইল এখন উন্মুক্ত করা হয়েছে' : 'আপনার প্রোফাইল এখন কেউ দেখতে পারবে না', newStatus ? 'success' : 'private');
                    } catch (error) {
                        console.error("Error updating status:", error);
                        showNotification("স্ট্যাটাস আপডেট ব্যর্থ হয়েছে", "private");
                    }
                };
            }

            function updatePublishButtonUI(isPublished) {
                if (isPublished) {
                    publishBtn.classList.add('btn-primary');
                    publishBtn.classList.remove('btn-outline');
                    publishBtn.innerHTML = '<i class="fas fa-eye-slash"></i> প্রাইভেট';
                } else {
                    publishBtn.classList.add('btn-outline');
                    publishBtn.classList.remove('btn-primary');
                    publishBtn.innerHTML = '<i class="fas fa-upload"></i> পাবলিশ';
                }
            }

            async function loadMyEmergencyPosts(uid) {
                const postsGrid = document.getElementById('myEmergencyPostsGrid');
                postsGrid.innerHTML = '<p>লোড হচ্ছে...</p>';

                const q = window.query(window.collection(window.db, "emergency_posts"), window.where("uid", "==", uid));
                
                try {
                    const querySnapshot = await window.getDocs(q);
                    postsGrid.innerHTML = ''; 

                    if (querySnapshot.empty) {
                        postsGrid.innerHTML = '<p style="text-align: center; color: var(--text-light); font-size: 1.1rem;">আপনি এখনো কোনো জরুরি পোস্ট করেননি।</p>';
                        return;
                    }

                    querySnapshot.forEach((doc) => {
                        const post = doc.data();
                        const postId = doc.id;
                        
                        const cardElement = document.createElement('div');
                        cardElement.className = 'my-post-card';
                        cardElement.innerHTML = `
                            <div class="my-post-card-body">
                                <div class="my-post-card-info"><i class="fas fa-tint"></i><div><span class="info-label">গ্রুপ:</span> ${post.bloodGroup}</div></div>
                                <div class="my-post-card-info"><i class="fas fa-map-marked-alt"></i><div><span class="info-label">স্থান:</span> ${post.upazila}, ${post.district}</div></div>
                                <div class="my-post-card-info"><i class="fas fa-phone"></i><div><span class="info-label">যোগাযোগ:</span> ${post.contact}</div></div>
                            </div>
                            <div class="my-post-card-footer">
                                <button class="btn btn-cancel" onclick="deletePost('${postId}')"><i class="fas fa-times"></i> ক্যানসেল করুন</button>
                            </div>
                        `;
                        postsGrid.appendChild(cardElement);
                    });
                } catch (error) {
                    console.error("Error loading posts:", error);
                    postsGrid.innerHTML = '<p>পোস্ট লোড করতে সমস্যা হয়েছে।</p>';
                }
            }

            // গ্লোবাল ফাংশন হিসেবে ডিলিট সেট করা
            window.deletePost = async (postId) => {
                if(confirm("আপনি কি নিশ্চিত যে এই পোস্টটি মুছে ফেলতে চান?")) {
                    try {
                        await window.deleteDoc(window.doc(window.db, "emergency_posts", postId));
                        showNotification('আপনার পোস্ট সফলভাবে মুছে ফেলা হয়েছে।', 'success');
                        // রিফ্রেশ লিস্ট
                        const user = window.auth.currentUser;
                        if(user) loadMyEmergencyPosts(user.uid);
                    } catch (error) {
                        console.error("Error deleting post:", error);
                        showNotification('পোস্ট মুছতে সমস্যা হয়েছে।', 'private');
                    }
                }
            };

            // বাটন ইভেন্ট লিসেনার
            editProfileBtn.addEventListener('click', () => { window.location.href = 'profile_edit.html'; });
            emergencyBtn.addEventListener('click', () => { window.location.href = 'emergency_blood_post.html'; });
            
            logoutBtn.addEventListener('click', async () => {
                try {
                    await window.signOut(window.auth);
                    window.location.href = 'index.html';
                } catch (error) {
                    console.error("Logout error:", error);
                }
            });

            const copyBtn = document.getElementById('copyBtn');
            if (copyBtn) {
                copyBtn.addEventListener('click', () => {
                    const numberToCopy = document.getElementById('mobileNumber').innerText;
                    navigator.clipboard.writeText(numberToCopy).then(() => {
                        const originalIconHTML = copyBtn.innerHTML;
                        copyBtn.innerHTML = '<i class="fas fa-check"></i>';
                        setTimeout(() => { copyBtn.innerHTML = originalIconHTML; }, 2000);
                    }).catch(err => alert('কপি করা যায়নি।'));
                });
            }

            // মোবাইল মেনু
            const toggleMobileMenu = () => {
                const isOpen = mobileNavWindow.classList.contains('open');
                navOverlay.style.display = isOpen ? 'none' : 'block';
                mobileNavWindow.classList.toggle('open');
            };
            mobileMenuIcon.addEventListener('click', toggleMobileMenu);
            closeMobileNavBtn.addEventListener('click', toggleMobileMenu);
            navOverlay.addEventListener('click', toggleMobileMenu);

            function initializePage() {
                profileViewSection.style.display = 'block';
                myPostsSection.style.display = 'block';
                viewModeButtons.style.display = 'flex';
                setTimeout(() => {
                    profileViewSection.classList.add('visible');
                    myPostsSection.classList.add('visible');
                    viewModeButtons.classList.add('visible');
                }, 10);
            }
        });
    </script>
</body>
</html>